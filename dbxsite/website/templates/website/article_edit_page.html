{% extends 'website/base.html' %}
{% block body_content %}
    <div class="container">
        <form role="form" method="post" action="{% url 'article:edit_action' %}" id="article-form">
            {% csrf_token %}
            <input type="hidden" name="article_id" value="{{ article.id | default:'0' }}"/>
            <div class="row">
                <div class="form-group">
                    <input title="title" type="text" name="title" class="form-control input-lg"
                           value="{{ article.title|default_if_none:'' }}" id="article-title"
                           placeholder="文章标题">
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <div class="dropdown">
                        <input type="hidden" name="editor" value="{{ editor }}">
                        <label for="select-editor">编辑器：</label>
                        <a class="btn btn-default dropdown-toggle" href="#" id="select-editor"
                           data-toggle="dropdown" style="margin-bottom: 10px">
                            {{ editor }}
                            <span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu" role="menu" aria-labelledby="select-editor">
                            <li role="presentation">
                                <a role="menuitem"
                                   href="{% url 'article:article_edit_page' article_id %}?editor=Markdown"
                                   tabindex="-1">Markdown</a>
                            </li>
                            <li role="presentation">
                                <a role="menuitem"
                                   href="{% url 'article:article_edit_page' article_id %}?editor=Summernote"
                                   tabindex="-1">Summernote</a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="col-md-8">
                    <input type="hidden" id="tags-value" value="{{ tags }}">
                    <input type="text" id="tag-input" class="form-control input-md" title="tags"
                           placeholder="请选择标签" autocomplete="off">
                </div>
            </div>
            <div class="row">
                {% if editor == 'Summernote' %}
                    <textarea style="display: none" name="content" title="content" id="content-area"></textarea>
                    <div class="form-group" id="article-editor">
                        {{ article.content|safe|linebreaks|default_if_none:'' }}
                    </div>
                {% elif editor == 'Markdown' %}
                    <div class="form-group" id="article-editor">
                    <textarea title="content" name="content" class="form-control" style="resize: none;"
                              rows="20" placeholder="在这里编辑文章内容"
                              id="article-content">{{ article.content|default_if_none:'' }}</textarea>
                    </div>
                {% endif %}
            </div>
            <div class="row">
                <div class="form-group">
                    <button class="btn btn-success btn-lg btn-block" type="button" id="submit-btn">提交</button>
                </div>
            </div>
        </form>
    </div>
    <script type="text/javascript">
        var editor_area = $('#article-editor');
        var editor = '{{ editor }}';

        if (editor == 'Summernote') {
            editor_area.summernote({
                placeholder: '在这里编辑文章内容',
                height: 500,
                fontNames: ['Arial', 'Consolas', 'Comic Sans MS', 'Courier New', 'Microsoft YaHei'],
                lang: 'zh-CN',
                enterHtml: '<p></p>' // '<br>', '<p>&nbsp;</p>', '<p><br></p>', '<div><br></div>'
            });
        }

        $('#submit-btn').on('click', function () {
            var articleTitle = $('#article-title').val(),
                    articleContent = $('#article-content').val();
            if ($.trim(articleTitle) == '') {
                BootstrapDialog.show({
                    type: BootstrapDialog.TYPE_DANGER,
                    title: "错误",
                    message: "文章标题不能为空！",
                    buttons: [{
                        label: '关闭',
                        action: function (dialogItself) {
                            dialogItself.close();
                        }
                    }]
                });
                return;
            }
            else {
                if (editor == 'Summernote') {
                    $('#content-area').text(editor_area.summernote('code'));
                }
                $('#article-form').submit();
            }
        });
        $('.dropdown-toggle').dropdown();

        var tag_input = $('#tag-input'),
                tags_value = $('#tags-value').val();
        var tag_obj = new Bloodhound({
            datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
            queryTokenizer: Bloodhound.tokenizers.whitespace,
            local: tags_value
        });
        tag_obj.initialize();
        console.log(tags_value);
        tag_input.typeahead({
            source: tag_obj.ttAdapter(),
            autoSelect: true
        });
        tag_input.change(function () {
            var current = tag_input.typeahead("getActive");
            if (current) {
                // Some item from your model is active!
                if (current.name == tag_input.val()) {
                    // This means the exact match is found. Use toLowerCase() if you want case insensitive match.
                } else {
                    // This means it is only a partial match, you can either add a new item
                    // or take the active if you don't want new items
                }
            } else {
                // Nothing is active so it is a new value (or maybe empty value)
            }
        });
        {#        tag_input.tagsinput({#}
        {#            itemValue: 'id',#}
        {#            itemText: 'name',#}
        {#            typeahead: {#}
        {#                name: 'tag_obj',#}
        {#                displayKey: 'name',#}
        {#                source: tag_obj.ttAdapter()#}
        {#            }#}
        {#        });#}
    </script>
{% endblock %}